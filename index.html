<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaadNote - Process Logbook</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: 90vh;
        }

        .sidebar {
            background: #f8f9fa;
            border-right: 2px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #6c757d;
            font-size: 13px;
        }

        .language-selector {
            margin-top: 10px;
        }

        .language-selector select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .language-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .clear-search {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .clear-search:hover {
            background: #c82333;
            transform: translateY(-50%) scale(1.1);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            grid-column: 1 / -1;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .notes-list {
            max-height: calc(90vh - 400px);
            overflow-y: auto;
        }

        .note-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
        }

        .note-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.2);
        }

        .note-item.active {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .note-item h3 {
            color: #495057;
            font-size: 15px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-item p {
            color: #6c757d;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: #adb5bd;
        }

        .editor-section {
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .editor-header input {
            font-size: 24px;
            font-weight: 700;
            border: none;
            color: #212529;
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .editor-header input:focus {
            outline: none;
            background: #f8f9fa;
        }

        .editor-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .toolbar-btn:hover {
            background: #e9ecef;
        }

        .editor-content {
            flex: 1;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            font-size: 15px;
            line-height: 1.8;
            resize: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 400px;
        }

        .editor-content:focus {
            outline: none;
            border-color: #667eea;
        }

        .editor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #e9ecef;
        }

        .tags-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-right: 15px;
        }

        .tags-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .footer-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .stats {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .stats h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
            font-size: 13px;
        }

        .stat-label {
            color: #6c757d;
        }

        .stat-value {
            color: #667eea;
            font-weight: 600;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #adb5bd;
            text-align: center;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #495057;
            font-size: 22px;
        }

        .modal-body textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 10px;
            margin-right: 5px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                grid-template-columns: 1fr;
            }
            .sidebar {
                display: none;
            }
            .editor-toolbar, .editor-footer, .editor-header .footer-buttons {
                display: none;
            }
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(50px);
            transition: all 0.3s;
            z-index: 2000;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        input[type="file"] {
            display: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f8f9fa;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        .highlight {
            background: linear-gradient(120deg, #ffd700 0%, #ffed4e 100%);
            padding: 2px 4px;
            border-radius: 3px;
            animation: pulse 1.5s ease-in-out infinite;
            font-weight: 600;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
        }

        .note-item.highlight-match {
            animation: vibrate 0.5s ease-in-out;
            border-color: #ffd700 !important;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        @keyframes vibrate {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        body.dark-mode .container {
            background: #2d2d3a;
            color: #e0e0e0;
        }

        body.dark-mode .sidebar {
            background: #1f1f2e;
            border-right-color: #3a3a4a;
        }

        body.dark-mode .search-box input,
        body.dark-mode .tags-input,
        body.dark-mode .editor-header input,
        body.dark-mode .editor-content {
            background: #2d2d3a;
            color: #e0e0e0;
            border-color: #3a3a4a;
        }

        body.dark-mode .note-item {
            background: #2d2d3a;
            border-color: #3a3a4a;
        }

        body.dark-mode .note-item:hover {
            background: #35354a;
        }

        body.dark-mode .note-item.active {
            background: #3a3a5a;
        }

        body.dark-mode .stats {
            background: #2d2d3a;
            border-color: #3a3a4a;
        }

        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4 {
            color: #e0e0e0;
        }

        body.dark-mode .toolbar-btn {
            background: #3a3a4a;
            border-color: #4a4a5a;
            color: #e0e0e0;
        }

        body.dark-mode .toolbar-btn:hover {
            background: #4a4a5a;
        }

        .word-count-live {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .favorites-section {
            margin-bottom: 15px;
        }

        .favorites-header {
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        .favorite-star {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        .favorite-star:hover {
            transform: scale(1.3) rotate(15deg);
        }

        .note-item {
            position: relative;
        }

        .export-options {
            display: none;
            position: absolute;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 100;
            min-width: 150px;
        }

        .export-options.active {
            display: block;
        }

        .export-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            margin-bottom: 5px;
        }

        .export-option:hover {
            background: #f8f9fa;
        }

        .voice-button {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.7);
        }

        .voice-button:active {
            transform: scale(0.95);
        }

        .shortcuts-help {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 11px;
            color: #6c757d;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .shortcuts-help:hover {
            background: #f8f9fa;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        body.dark-mode .voice-button {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        body.dark-mode .shortcuts-help {
            background: #2d2d3a;
            color: #adb5bd;
        }

        .locked-note {
            opacity: 0.6;
            position: relative;
        }

        .locked-note::after {
            content: 'üîí';
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 16px;
        }

        .version-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
        }

        .version-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .version-preview {
            color: #6c757d;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-day {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e9ecef;
        }

        .calendar-day:hover {
            background: #e9ecef;
            transform: scale(1.05);
        }

        .calendar-day.has-notes {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .calendar-day-number {
            font-size: 18px;
            font-weight: 600;
        }

        .calendar-day-count {
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.8;
        }

        .calendar-header {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 20px;
        }

        .note-color-picker {
            position: absolute;
            top: 10px;
            right: 50px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
        }

        .note-color-picker:hover {
            transform: scale(1.2);
        }

        .color-options {
            display: none;
            position: absolute;
            top: 45px;
            right: 50px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .color-options.active {
            display: flex;
            gap: 8px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .color-option:hover {
            transform: scale(1.2);
            border-color: #667eea;
        }

        .pin-note {
            position: absolute;
            top: 45px;
            right: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pin-note:hover {
            transform: scale(1.2) rotate(15deg);
        }

        .pinned-badge {
            position: absolute;
            top: 40px;
            right: 45px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="header">
                <h1>üìù SaadNote</h1>
                <p id="headerSubtitle">Process Logbook</p>
                <div class="language-selector">
                    <select id="languageSelect" onchange="changeLanguage()">
                        <option value="en">üá¨üáß English</option>
                        <option value="it">üáÆüáπ Italiano</option>
                    </select>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search notes...">
                <span class="search-icon">üîç</span>
                <button class="clear-search" id="clearSearchBtn" onclick="clearSearch()" style="display: none;">‚úñ</button>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="createNewNote()" id="btnNewNote">
                    ‚ûï New Note
                </button>
                <button class="btn btn-secondary" onclick="importNotes()" id="btnImport">
                    üì• Import
                </button>
                <button class="btn btn-secondary" onclick="exportNotes()" id="btnExport">
                    üì§ Export
                </button>
                <button class="btn btn-secondary" onclick="sortNotes()" id="btnSort">
                    üîÑ Sort
                </button>
                <button class="btn btn-secondary" onclick="backupToCloud()" id="btnBackup">
                    ‚òÅÔ∏è Backup
                </button>
                <button class="btn btn-secondary" onclick="showCalendar()" id="btnCalendar">
                    üìÖ Calendar
                </button>
            </div>

            <div class="notes-list" id="notesList">
                <!-- Notes will be populated here -->
            </div>

            <div class="stats">
                <h4>üìä <span id="statsTitle">Statistics</span></h4>
                <div class="stat-item">
                    <span class="stat-label" id="statTotalNotes">Total Notes:</span>
                    <span class="stat-value" id="totalNotes">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label" id="statFavorites">Favorites:</span>
                    <span class="stat-value" id="totalFavorites">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label" id="statTotalWords">Total Words:</span>
                    <span class="stat-value" id="totalWords">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label" id="statLastUpdated">Last Updated:</span>
                    <span class="stat-value" id="lastUpdated">Never</span>
                </div>
            </div>
        </div>

        <!-- Editor Section -->
        <div class="editor-section" id="editorSection">
            <div id="emptyState" class="empty-state">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                <h2>Welcome to SaadNote!</h2>
                <p>Your process logbook - Create your first note to get started</p>
            </div>

                <div class="editor-header">
                    <input type="text" id="noteTitle" placeholder="Note Title (e.g., Process Documentation)">
                    <div class="note-color-picker" onclick="toggleColorPicker()" id="currentColor" style="background: #ffffff;" title="Change color"></div>
                    <div class="color-options" id="colorOptions">
                        <div class="color-option" style="background: #ffffff;" onclick="setNoteColor('#ffffff')" title="White"></div>
                        <div class="color-option" style="background: #ffd7d7;" onclick="setNoteColor('#ffd7d7')" title="Red"></div>
                        <div class="color-option" style="background: #fff4cc;" onclick="setNoteColor('#fff4cc')" title="Yellow"></div>
                        <div class="color-option" style="background: #d7f4d7;" onclick="setNoteColor('#d7f4d7')" title="Green"></div>
                        <div class="color-option" style="background: #d7e9ff;" onclick="setNoteColor('#d7e9ff')" title="Blue"></div>
                        <div class="color-option" style="background: #f4d7ff;" onclick="setNoteColor('#f4d7ff')" title="Purple"></div>
                    </div>
                    <span class="pin-note" onclick="togglePin()" id="pinIcon" title="Pin to top">üìå</span>
                    <span class="favorite-star" onclick="toggleFavorite()" title="Add to favorites">‚òÜ</span>
                </div>

                <div class="editor-toolbar">
                    <button class="toolbar-btn" onclick="addTemplate('note')" id="btnSimpleNote">üìù Simple Note</button>
                    <button class="toolbar-btn" onclick="addTemplate('instructions')" id="btnInstructions">üìã Instructions</button>
                    <button class="toolbar-btn" onclick="addTemplate('checklist')" id="btnChecklist">‚úÖ Checklist</button>
                    <button class="toolbar-btn" onclick="insertDateTime()" id="btnDateTime">üïí Date/Time</button>
                    <button class="toolbar-btn" onclick="duplicateNote()" id="btnDuplicate">üìã Duplicate</button>
                    <button class="toolbar-btn" onclick="toggleDarkMode()" id="btnDarkMode">üåô Dark Mode</button>
                    <button class="toolbar-btn" onclick="formatText('bold')" id="btnBold">üî§ Bold</button>
                    <button class="toolbar-btn" onclick="formatText('italic')" id="btnItalic">üî§ Italic</button>
                    <button class="toolbar-btn" onclick="formatText('highlight')" id="btnHighlight">‚úèÔ∏è Highlight</button>
                    <button class="toolbar-btn" onclick="formatText('underline')" id="btnUnderline">__ Underline</button>
                    <button class="toolbar-btn" onclick="improveWithAI()" id="btnAiImprove" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold;">‚ú® AI Improve</button>
                </div>

                <div style="position: relative; flex: 1; display: flex; flex-direction: column;">
                    <span class="word-count-live" id="wordCountLive">0 words</span>
                    <textarea class="editor-content" id="noteContent" placeholder="Start writing your process notes here...

Example:
- Process documentation
- Step-by-step procedures
- Important reminders
- Work instructions"></textarea>
                </div>

                <div class="editor-footer">
                    <input type="text" class="tags-input" id="noteTags" placeholder="Tags (e.g., recipe, cream, atritor)">
                    <div class="footer-buttons">
                        <button class="btn btn-success" onclick="saveCurrentNote()" id="btnSave">üíæ Save</button>
                        <button class="btn btn-warning" onclick="addReminder()" id="btnReminder">‚è∞ Reminder</button>
                        <button class="btn btn-info" onclick="textToSpeech()" id="btnRead">üîä Read</button>
                        <button class="btn btn-info" onclick="translateNote()" id="btnTranslate">üåç Translate</button>
                        <button class="btn btn-secondary" onclick="lockNote()" id="btnLock">üîí Lock</button>
                        <button class="btn btn-secondary" onclick="viewHistory()" id="btnHistory">üìú History</button>
                        <button class="btn btn-secondary" onclick="addImage()" id="btnImage">üñºÔ∏è Image</button>
                        <button class="btn btn-info" onclick="generatePDF()" id="btnPdf">üìÑ PDF</button>
                        <button class="btn btn-warning" onclick="printNote()" id="btnPrint">üñ®Ô∏è Print</button>
                        <button class="btn btn-info" onclick="emailNote()" id="btnEmail">üìß Email</button>
                        <button class="btn btn-danger" onclick="deleteCurrentNote()" id="btnDelete">üóëÔ∏è Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="passwordModalTitle">üîí Lock Note</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #6c757d;" id="passwordModalDesc">Set a password to protect this note:</p>
                <input type="password" id="passwordInput" placeholder="Enter password" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; margin-bottom: 10px;">
                <input type="password" id="passwordConfirm" placeholder="Confirm password" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmPassword()">üîí Lock</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üìú Note History</h2>
            </div>
            <div class="modal-body" id="historyContent" style="max-height: 400px; overflow-y: auto;">
                <!-- History versions will appear here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeHistoryModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div class="modal" id="calendarModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üìÖ Notes Calendar</h2>
            </div>
            <div class="modal-body" id="calendarContent">
                <!-- Calendar will appear here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCalendarModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Voice Input Button -->
    <button class="voice-button" onclick="startVoiceInput()" title="Voice Input (Ctrl+Shift+V)">üé§</button>

    <!-- Shortcuts Help -->
    <div class="shortcuts-help" onclick="showShortcuts()">‚å®Ô∏è Shortcuts</div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".json" onchange="handleImport(event)">
    <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // Language translations
        const translations = {
            en: {
                headerSubtitle: "Process Logbook",
                searchPlaceholder: "Search notes...",
                newNote: "‚ûï New Note",
                import: "üì• Import",
                export: "üì§ Export",
                sort: "üîÑ Sort",
                backup: "‚òÅÔ∏è Backup",
                calendar: "üìÖ Calendar",
                totalNotes: "Total Notes:",
                favorites: "Favorites:",
                totalWords: "Total Words:",
                lastUpdated: "Last Updated:",
                never: "Never",
                welcomeTitle: "Welcome to SaadNote!",
                welcomeText: "Your process logbook - Create your first note to get started",
                noteTitle: "Note Title (e.g., Process Documentation)",
                notePlaceholder: "Start writing your process notes here...\n\nExample:\n- Process documentation\n- Step-by-step procedures\n- Important reminders\n- Work instructions",
                tagsPlaceholder: "Tags (e.g., recipe, cream, atritor)",
                save: "üíæ Save",
                reminder: "‚è∞ Reminder",
                read: "üîä Read",
                translate: "üåç Translate",
                lock: "üîí Lock",
                history: "üìú History",
                image: "üñºÔ∏è Image",
                pdf: "üìÑ PDF",
                print: "üñ®Ô∏è Print",
                email: "üìß Email",
                delete: "üóëÔ∏è Delete",
                simpleNote: "üìù Simple Note",
                instructions: "üìã Instructions",
                checklist: "‚úÖ Checklist",
                dateTime: "üïí Date/Time",
                duplicate: "üìã Duplicate",
                darkMode: "üåô Dark Mode",
                bold: "üî§ Bold",
                italic: "üî§ Italic",
                highlight: "‚úèÔ∏è Highlight",
                underline: "__ Underline",
                aiImprove: "‚ú® AI Improve",
                words: "words",
                chars: "chars",
                pinned: "üìç Pinned",
                allNotes: "üìù All Notes"
            },
            it: {
                headerSubtitle: "Registro dei Processi",
                searchPlaceholder: "Cerca note...",
                newNote: "‚ûï Nuova Nota",
                import: "üì• Importa",
                export: "üì§ Esporta",
                sort: "üîÑ Ordina",
                backup: "‚òÅÔ∏è Backup",
                calendar: "üìÖ Calendario",
                totalNotes: "Note Totali:",
                favorites: "Preferiti:",
                totalWords: "Parole Totali:",
                lastUpdated: "Ultimo Aggiornamento:",
                never: "Mai",
                welcomeTitle: "Benvenuto in SaadNote!",
                welcomeText: "Il tuo registro dei processi - Crea la tua prima nota per iniziare",
                noteTitle: "Titolo Nota (es., Documentazione Processo)",
                notePlaceholder: "Inizia a scrivere le tue note di processo qui...\n\nEsempio:\n- Documentazione processo\n- Procedure passo dopo passo\n- Promemoria importanti\n- Istruzioni di lavoro",
                tagsPlaceholder: "Tag (es., ricetta, crema, atritor)",
                save: "üíæ Salva",
                reminder: "‚è∞ Promemoria",
                read: "üîä Leggi",
                translate: "üåç Traduci",
                lock: "üîí Blocca",
                history: "üìú Cronologia",
                image: "üñºÔ∏è Immagine",
                pdf: "üìÑ PDF",
                print: "üñ®Ô∏è Stampa",
                email: "üìß Email",
                delete: "üóëÔ∏è Elimina",
                simpleNote: "üìù Nota Semplice",
                instructions: "üìã Istruzioni",
                checklist: "‚úÖ Lista di Controllo",
                dateTime: "üïí Data/Ora",
                duplicate: "üìã Duplica",
                darkMode: "üåô Modalit√† Scura",
                bold: "üî§ Grassetto",
                italic: "üî§ Corsivo",
                highlight: "‚úèÔ∏è Evidenzia",
                underline: "__ Sottolinea",
                aiImprove: "‚ú® Migliora con IA",
                words: "parole",
                chars: "caratteri",
                pinned: "üìç Fissate",
                allNotes: "üìù Tutte le Note"
            }
        };

        let currentLanguage = 'en';

        // Change language
        function changeLanguage() {
            currentLanguage = document.getElementById('languageSelect').value;
            localStorage.setItem('saadnoteLanguage', currentLanguage);
            updateUILanguage();
        }

        // Update UI with current language
        function updateUILanguage() {
            const t = translations[currentLanguage];
            
            // Update header
            document.getElementById('headerSubtitle').textContent = t.headerSubtitle;
            
            // Update search
            document.getElementById('searchInput').placeholder = t.searchPlaceholder;
            
            // Update action buttons
            const actionButtons = {
                'btnNewNote': t.newNote,
                'btnImport': t.import,
                'btnExport': t.export,
                'btnSort': t.sort,
                'btnBackup': t.backup,
                'btnCalendar': t.calendar
            };

            for (const [id, text] of Object.entries(actionButtons)) {
                const btn = document.getElementById(id);
                if (btn) btn.textContent = text;
            }
            
            // Update toolbar buttons
            const toolbarButtons = {
                'btnSimpleNote': t.simpleNote,
                'btnInstructions': t.instructions,
                'btnChecklist': t.checklist,
                'btnDateTime': t.dateTime,
                'btnDuplicate': t.duplicate,
                'btnDarkMode': t.darkMode,
                'btnBold': t.bold,
                'btnItalic': t.italic,
                'btnHighlight': t.highlight,
                'btnUnderline': t.underline,
                'btnAiImprove': t.aiImprove
            };

            for (const [id, text] of Object.entries(toolbarButtons)) {
                const btn = document.getElementById(id);
                if (btn) btn.textContent = text;
            }

            // Update footer buttons
            const footerButtons = {
                'btnSave': t.save,
                'btnReminder': t.reminder,
                'btnRead': t.read,
                'btnTranslate': t.translate,
                'btnLock': t.lock,
                'btnHistory': t.history,
                'btnImage': t.image,
                'btnPdf': t.pdf,
                'btnPrint': t.print,
                'btnEmail': t.email,
                'btnDelete': t.delete
            };

            for (const [id, text] of Object.entries(footerButtons)) {
                const btn = document.getElementById(id);
                if (btn) btn.textContent = text;
            }

            // Update stats
            document.getElementById('statTotalNotes').textContent = t.totalNotes;
            document.getElementById('statFavorites').textContent = t.favorites;
            document.getElementById('statTotalWords').textContent = t.totalWords;
            document.getElementById('statLastUpdated').textContent = t.lastUpdated;
            if (document.getElementById('lastUpdated').textContent === 'Never') {
                document.getElementById('lastUpdated').textContent = t.never;
            }
            
            // Update placeholders
            document.getElementById('noteTitle').placeholder = t.noteTitle;
            document.getElementById('noteContent').placeholder = t.notePlaceholder;
            document.getElementById('noteTags').placeholder = t.tagsPlaceholder;
            
            // Update empty state
            document.querySelector('#emptyState h2').textContent = t.welcomeTitle;
            document.querySelector('#emptyState p').textContent = t.welcomeText;
            
            // Re-render notes list to update section headers
            renderNotesList();
            
            // Update word count
            if (currentNoteId) {
                updateWordCount();
            }
        }

        // Data structure
        let notes = [];
        let currentNoteId = null;

        // Load notes from localStorage on startup
        function loadNotes() {
            const saved = localStorage.getItem('saadnoteNotes');
            if (saved) {
                notes = JSON.parse(saved);
                renderNotesList();
                updateStats();
            }
        }

        // Save notes to localStorage
        function saveNotes() {
            localStorage.setItem('saadnoteNotes', JSON.stringify(notes));
            updateStats();
        }

        // Create new note
        function createNewNote() {
            const newNote = {
                id: Date.now(),
                title: 'Untitled Note',
                content: '',
                tags: '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                favorite: false,
                locked: false,
                password: null,
                color: '#ffffff',
                pinned: false,
                history: []
            };
            notes.unshift(newNote);
            currentNoteId = newNote.id;
            renderNotesList();
            displayNote(newNote);
            document.getElementById('noteTitle').focus();
            showToast('‚ú® New note created!');
        }

        // Display note in editor
        function displayNote(note) {
            // Check if note is locked
            if (note.locked && note.password) {
                const entered = prompt('üîí This note is locked. Enter password:');
                if (entered !== note.password) {
                    showToast('‚ùå Wrong password!');
                    return;
                }
            }

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('editorArea').style.display = 'flex';
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            document.getElementById('noteTags').value = note.tags || '';
            currentNoteId = note.id;
            
            // Update favorite star
            const star = document.querySelector('.favorite-star');
            star.textContent = note.favorite ? '‚≠ê' : '‚òÜ';
            
            // Update pin icon
            const pin = document.getElementById('pinIcon');
            pin.textContent = note.pinned ? 'üìç' : 'üìå';
            
            // Update color
            if (note.color) {
                document.getElementById('currentColor').style.background = note.color;
                document.getElementById('noteContent').style.background = note.color;
            }
            
            // Update word count
            updateWordCount();
        }

        // Save current note
        function saveCurrentNote() {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                // Save to history before updating
                if (!note.history) note.history = [];
                note.history.push({
                    title: note.title,
                    content: note.content,
                    savedAt: note.updatedAt
                });
                // Keep only last 10 versions
                if (note.history.length > 10) note.history.shift();

                note.title = document.getElementById('noteTitle').value || 'Untitled Note';
                note.content = document.getElementById('noteContent').value;
                note.tags = document.getElementById('noteTags').value;
                note.updatedAt = new Date().toISOString();
                saveNotes();
                renderNotesList();
                showToast('üíæ Note saved successfully!');
            }
        }

        // Delete current note with password protection
        function deleteCurrentNote() {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;
            
            // Password protection
            const password = prompt('üîí Enter password to delete this note:');
            if (password !== '7604') {
                showToast('‚ùå Wrong password! Cannot delete note.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete "${note.title}"?`)) {
                notes = notes.filter(n => n.id !== currentNoteId);
                saveNotes();
                renderNotesList();
                document.getElementById('emptyState').style.display = 'flex';
                document.getElementById('editorArea').style.display = 'none';
                currentNoteId = null;
                showToast('üóëÔ∏è Note deleted!');
            }
        }

        // Render notes list
        function renderNotesList() {
            const listEl = document.getElementById('notesList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const t = translations[currentLanguage];
            
            const filteredNotes = notes.filter(note => 
                note.title.toLowerCase().includes(searchTerm) ||
                note.content.toLowerCase().includes(searchTerm) ||
                (note.tags && note.tags.toLowerCase().includes(searchTerm))
            );

            // Separate pinned, favorites, and regular
            const pinned = filteredNotes.filter(n => n.pinned);
            const favorites = filteredNotes.filter(n => !n.pinned && n.favorite);
            const regular = filteredNotes.filter(n => !n.pinned && !n.favorite);

            if (filteredNotes.length === 0) {
                listEl.innerHTML = `<p style="text-align: center; color: #adb5bd; padding: 20px;">${currentLanguage === 'it' ? 'Nessuna nota trovata' : 'No notes found'}</p>`;
                return;
            }

            let html = '';

            // Render pinned first
            if (pinned.length > 0) {
                html += `<div class="favorites-section"><div class="favorites-header">${t.pinned}</div>`;
                html += pinned.map(note => renderNoteItem(note, searchTerm)).join('');
                html += '</div>';
            }

            // Render favorites
            if (favorites.length > 0) {
                html += `<div class="favorites-section"><div class="favorites-header">‚≠ê ${t.favorites}</div>`;
                html += favorites.map(note => renderNoteItem(note, searchTerm)).join('');
                html += '</div>';
            }

            // Render regular notes
            if (regular.length > 0) {
                if (favorites.length > 0 || pinned.length > 0) {
                    html += `<div class="favorites-header">${t.allNotes}</div>`;
                }
                html += regular.map(note => renderNoteItem(note, searchTerm)).join('');
            }

            listEl.innerHTML = html;
        }

        // Render individual note item with highlighting
        function renderNoteItem(note, searchTerm) {
            const highlightText = (text, term) => {
                if (!term) return text;
                const regex = new RegExp(`(${term})`, 'gi');
                return text.replace(regex, '<span class="highlight">$1</span>');
            };

            const hasMatch = searchTerm && (
                note.title.toLowerCase().includes(searchTerm) ||
                note.content.toLowerCase().includes(searchTerm) ||
                (note.tags && note.tags.toLowerCase().includes(searchTerm))
            );

            const title = highlightText(note.title, searchTerm);
            const preview = highlightText(note.content.substring(0, 60), searchTerm);
            const tags = note.tags ? note.tags.split(',').map(tag => {
                const highlightedTag = highlightText(tag.trim(), searchTerm);
                return `<span class="category-badge">${highlightedTag}</span>`;
            }).join('') : '';

            const bgStyle = note.color && note.color !== '#ffffff' ? `background: ${note.color};` : '';
            const titleBgStyle = note.color && note.color !== '#ffffff' ? `background: ${note.color}; padding: 8px; margin: -15px -15px 10px -15px; border-radius: 8px 8px 0 0;` : '';

            return `
                <div class="note-item ${note.id === currentNoteId ? 'active' : ''} ${hasMatch ? 'highlight-match' : ''} ${note.locked ? 'locked-note' : ''}" 
                     onclick="selectNote(${note.id})" style="${bgStyle}">
                    <h3 style="${titleBgStyle}">${title}</h3>
                    <p>${preview}${note.content.length > 60 ? '...' : ''}</p>
                    ${tags ? `<div style="margin-top: 5px;">${tags}</div>` : ''}
                    <div class="note-meta">
                        <span>üìÖ ${new Date(note.updatedAt).toLocaleDateString()}</span>
                        <span>${countWords(note.content)} words</span>
                    </div>
                    ${note.pinned ? '<span class="pinned-badge">üìç</span>' : ''}
                    ${note.favorite ? '<span style="position: absolute; top: 10px; right: 10px; font-size: 18px;">‚≠ê</span>' : ''}
                </div>
            `;
        }

        // Select note
        function selectNote(id) {
            const note = notes.find(n => n.id === id);
            if (note) {
                // Auto-save current note before switching
                if (currentNoteId) {
                    saveCurrentNote();
                }
                displayNote(note);
                renderNotesList(); // Update active state
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const clearBtn = document.getElementById('clearSearchBtn');
            if (e.target.value) {
                clearBtn.style.display = 'flex';
            } else {
                clearBtn.style.display = 'none';
            }
            renderNotesList();
        });

        // Export notes
        function exportNotes() {
            const dataStr = JSON.stringify(notes, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `saadnote-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showToast('üì§ Notes exported successfully!');
        }

        // Import notes
        function importNotes() {
            document.getElementById('fileInput').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedNotes = JSON.parse(e.target.result);
                    if (confirm(`Import ${importedNotes.length} notes? This will merge with existing notes.`)) {
                        notes = [...notes, ...importedNotes];
                        saveNotes();
                        renderNotesList();
                        showToast('üì• Notes imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing file. Please make sure it\'s a valid JSON file.');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        // Generate PDF
        function generatePDF() {
            if (!currentNoteId) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const note = notes.find(n => n.id === currentNoteId);
            
            // Title
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            const cleanTitle = note.title.replace(/[^\x20-\x7E]/g, ''); // Remove special chars
            doc.text(cleanTitle || 'Untitled', 20, 20);
            
            // Metadata
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Created: ${new Date(note.createdAt).toLocaleString()}`, 20, 30);
            doc.text(`Updated: ${new Date(note.updatedAt).toLocaleString()}`, 20, 35);
            if (note.tags) {
                const cleanTags = note.tags.replace(/[^\x20-\x7E]/g, '');
                doc.text(`Tags: ${cleanTags}`, 20, 40);
            }
            
            // Content - clean special characters
            doc.setFontSize(12);
            const cleanContent = note.content.replace(/[^\x20-\x7E\n\r]/g, '');
            const splitContent = doc.splitTextToSize(cleanContent, 170);
            doc.text(splitContent, 20, 50);
            
            // Save with clean filename
            const filename = note.title.replace(/[^a-z0-9]/gi, '_').substring(0, 50);
            doc.save(`${filename || 'note'}.pdf`);
            showToast('üìÑ PDF generated successfully!');
        }

        // Print note
        function printNote() {
            if (!currentNoteId) return;
            saveCurrentNote(); // Save before printing
            window.print();
        }

        // Email note
        function emailNote() {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            const subject = encodeURIComponent(note.title);
            const body = encodeURIComponent(`${note.content}\n\n---\nCreated: ${new Date(note.createdAt).toLocaleString()}\nTags: ${note.tags || 'None'}`);
            
            const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&su=${subject}&body=${body}`;
            
            // Open directly in new tab
            window.open(gmailLink, '_blank');
            showToast('üìß Opening Gmail...');
        }

        // Add templates
        function addTemplate(type) {
            const content = document.getElementById('noteContent');
            let template = '';
            
            switch(type) {
                case 'note':
                    template = `

üìù NOTE
========================
Date: ${new Date().toLocaleDateString()}
Time: ${new Date().toLocaleTimeString()}

Write your note here...


`;
                    break;
                case 'instructions':
                    template = `

üìñ INSTRUCTIONS
========================
Task: 
Date: ${new Date().toLocaleDateString()}
Time: ${new Date().toLocaleTimeString()}

STEPS:
1. Open Atritor program
2. 
3. 
4. 

IMPORTANT:
‚ö†Ô∏è 

`;
                    break;
                case 'checklist':
                    template = `

‚úÖ CHECKLIST
========================
Date: ${new Date().toLocaleDateString()}
Time: ${new Date().toLocaleTimeString()}

‚òê 
‚òê 
‚òê 
‚òê 

`;
                    break;
            }
            
            content.value += template;
            content.focus();
            updateWordCount();
        }

        // Insert date/time
        function insertDateTime() {
            const content = document.getElementById('noteContent');
            const now = new Date();
            const dateTime = `[${now.toLocaleString()}] `;
            const start = content.selectionStart;
            const end = content.selectionEnd;
            content.value = content.value.substring(0, start) + dateTime + content.value.substring(end);
            content.focus();
            content.setSelectionRange(start + dateTime.length, start + dateTime.length);
            updateWordCount();
        }

        // Toggle favorite
        function toggleFavorite() {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.favorite = !note.favorite;
                const star = document.querySelector('.favorite-star');
                star.textContent = note.favorite ? '‚≠ê' : '‚òÜ';
                saveNotes();
                renderNotesList();
                showToast(note.favorite ? '‚≠ê Added to favorites!' : '‚òÜ Removed from favorites');
            }
        }

        // Duplicate note
        function duplicateNote() {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                const duplicate = {
                    ...note,
                    id: Date.now(),
                    title: note.title + ' (Copy)',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    favorite: false
                };
                notes.unshift(duplicate);
                saveNotes();
                renderNotesList();
                displayNote(duplicate);
                showToast('üìã Note duplicated!');
            }
        }

        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            showToast(isDark ? 'üåô Dark mode enabled' : '‚òÄÔ∏è Light mode enabled');
        }

        // Update word count
        function updateWordCount() {
            const content = document.getElementById('noteContent').value;
            const words = countWords(content);
            const chars = content.length;
            const t = translations[currentLanguage];
            document.getElementById('wordCountLive').textContent = `${words} ${t.words} ‚Ä¢ ${chars} ${t.chars}`;
        }

        // Format text (bold, italic, highlight, underline)
        function formatText(type) {
            const textarea = document.getElementById('noteContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (!selectedText) {
                showToast('‚ö†Ô∏è Please select text first');
                return;
            }
            
            let formattedText = '';
            switch(type) {
                case 'bold':
                    formattedText = `**${selectedText}**`;
                    break;
                case 'italic':
                    formattedText = `*${selectedText}*`;
                    break;
                case 'highlight':
                    formattedText = `==${selectedText}==`;
                    break;
                case 'underline':
                    formattedText = `__${selectedText}__`;
                    break;
            }
            
            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start, start + formattedText.length);
            updateWordCount();
            showToast(`‚úèÔ∏è Text formatted as ${type}`);
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            renderNotesList();
        }

        // AI Improve text - Corrects grammar and rewrites professionally
        async function improveWithAI() {
            if (!currentNoteId) {
                showToast('‚ùå ' + (currentLanguage === 'it' ? 'Seleziona prima una nota' : 'Please select a note first'));
                return;
            }

            const content = document.getElementById('noteContent').value;
            if (!content.trim()) {
                showToast('‚ùå ' + (currentLanguage === 'it' ? 'La nota √® vuota' : 'Note is empty'));
                return;
            }

            const title = document.getElementById('noteTitle').value;

            // Show loading
            const originalBtn = document.getElementById('btnAiImprove');
            const originalText = originalBtn.textContent;
            originalBtn.textContent = currentLanguage === 'it' ? '‚è≥ Miglioramento...' : '‚è≥ Improving...';
            originalBtn.disabled = true;

            try {
                const targetLang = currentLanguage === 'it' ? 'Italian' : 'English';
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `You are a professional text editor. Please improve this text by:
1. Correcting all grammar and spelling errors
2. Rewriting it in a clear, professional, and well-organized manner
3. Maintaining the original meaning and key information
4. Organizing it with proper structure (sections, bullet points if needed)
5. Write the output in ${targetLang}

Title: ${title}

Text to improve:
${content}

Please provide ONLY the improved text without any explanations or meta-commentary.`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const improvedText = data.content[0].text;

                // Update the note content
                document.getElementById('noteContent').value = improvedText;
                updateWordCount();
                
                showToast('‚ú® ' + (currentLanguage === 'it' ? 'Testo migliorato con successo!' : 'Text improved successfully!'));
                
                // Auto-save the improved version
                setTimeout(() => saveCurrentNote(), 500);

            } catch (error) {
                console.error('AI Improve error:', error);
                showToast('‚ùå ' + (currentLanguage === 'it' ? 
                    'Errore nel miglioramento. Riprova pi√π tardi.' : 
                    'Error improving text. Please try again later.'));
            } finally {
                // Restore button
                originalBtn.textContent = originalText;
                originalBtn.disabled = false;
            }
        }

        // Add reminder
        function addReminder() {
            const content = document.getElementById('noteContent');
            const reminder = prompt('Set a reminder (e.g., "Follow up tomorrow", "Check in 3 days"):');
            if (reminder) {
                const reminderText = `\n\n‚è∞ REMINDER: ${reminder}\nSet on: ${new Date().toLocaleString()}\n`;
                content.value += reminderText;
                updateWordCount();
                showToast('‚è∞ Reminder added!');
            }
        }

        // Text to speech
        function textToSpeech() {
            if (!currentNoteId) {
                showToast('‚ùå Please select a note first');
                return;
            }

            const content = document.getElementById('noteContent').value;
            if (!content) {
                showToast('‚ùå Note is empty');
                return;
            }

            if ('speechSynthesis' in window) {
                // Stop any ongoing speech
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(content);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                utterance.onstart = () => showToast('üîä Reading note...');
                utterance.onend = () => showToast('‚úÖ Finished reading');
                utterance.onerror = () => showToast('‚ùå Error reading note');
                
                window.speechSynthesis.speak(utterance);
            } else {
                showToast('‚ùå Text-to-speech not supported in your browser');
            }
        }

        // Translate note (opens Google Translate)
        function translateNote() {
            if (!currentNoteId) {
                showToast('‚ùå Please select a note first');
                return;
            }

            const content = document.getElementById('noteContent').value;
            if (!content) {
                showToast('‚ùå Note is empty');
                return;
            }

            const encodedText = encodeURIComponent(content);
            const translateUrl = `https://translate.google.com/?sl=auto&tl=en&text=${encodedText}&op=translate`;
            window.open(translateUrl, '_blank');
            showToast('üåç Opening Google Translate...');
        }

        // Sort notes
        let sortOrder = 'newest'; // newest, oldest, alphabetical, mostWords
        function sortNotes() {
            const options = ['Newest First', 'Oldest First', 'A-Z', 'Most Words'];
            const choice = prompt(`Choose sort order:\n1. ${options[0]}\n2. ${options[1]}\n3. ${options[2]}\n4. ${options[3]}\n\nEnter 1-4:`);
            
            switch(choice) {
                case '1':
                    notes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    sortOrder = 'newest';
                    break;
                case '2':
                    notes.sort((a, b) => new Date(a.updatedAt) - new Date(b.updatedAt));
                    sortOrder = 'oldest';
                    break;
                case '3':
                    notes.sort((a, b) => a.title.localeCompare(b.title));
                    sortOrder = 'alphabetical';
                    break;
                case '4':
                    notes.sort((a, b) => countWords(b.content) - countWords(a.content));
                    sortOrder = 'mostWords';
                    break;
                default:
                    return;
            }
            
            renderNotesList();
            showToast(`üîÑ Sorted: ${options[parseInt(choice) - 1]}`);
        }

        // Backup to cloud (download with full timestamp - different from export)
        function backupToCloud() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            const dataStr = JSON.stringify(notes, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `saadnote-BACKUP-${timestamp}.json`;
            link.click();
            showToast('‚òÅÔ∏è Backup created with timestamp!');
        }

        // Voice input (Speech Recognition)
        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showToast('‚ùå Voice input not supported in your browser');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            const content = document.getElementById('noteContent');
            let finalTranscript = '';

            recognition.onstart = () => {
                showToast('üé§ Listening... Speak now!');
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                content.value = finalTranscript + interimTranscript;
                updateWordCount();
            };

            recognition.onerror = (event) => {
                showToast('‚ùå Voice recognition error');
                recognition.stop();
            };

            recognition.onend = () => {
                showToast('üé§ Voice input stopped');
            };

            recognition.start();
            
            // Stop after 30 seconds
            setTimeout(() => recognition.stop(), 30000);
        }

        // Show keyboard shortcuts
        function showShortcuts() {
            const shortcuts = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚å®Ô∏è  KEYBOARD SHORTCUTS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Ctrl/Cmd + S .......... Save note
Ctrl/Cmd + N .......... New note
Ctrl/Cmd + P .......... Print note
Ctrl/Cmd + F .......... Search notes
Ctrl/Cmd + D .......... Duplicate note
Ctrl/Cmd + K .......... Toggle dark mode
Ctrl/Cmd + Shift + V .. Voice input

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
            `;
            alert(shortcuts);
        }

        // Lock/Unlock note
        let lockAction = 'lock';
        function lockNote() {
            if (!currentNoteId) {
                showToast('‚ùå Please select a note first');
                return;
            }

            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            if (note.locked) {
                // Unlock
                const entered = prompt('üîì Enter password to unlock:');
                if (entered === note.password) {
                    note.locked = false;
                    note.password = null;
                    saveNotes();
                    renderNotesList();
                    showToast('üîì Note unlocked!');
                } else {
                    showToast('‚ùå Wrong password!');
                }
            } else {
                // Lock
                lockAction = 'lock';
                document.getElementById('passwordModalTitle').textContent = 'üîí Lock Note';
                document.getElementById('passwordModalDesc').textContent = 'Set a password to protect this note:';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordConfirm').value = '';
                document.getElementById('passwordModal').classList.add('active');
            }
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
        }

        function confirmPassword() {
            const pass = document.getElementById('passwordInput').value;
            const confirm = document.getElementById('passwordConfirm').value;

            if (!pass) {
                showToast('‚ùå Password cannot be empty');
                return;
            }

            if (pass !== confirm) {
                showToast('‚ùå Passwords do not match');
                return;
            }

            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.locked = true;
                note.password = pass;
                saveNotes();
                renderNotesList();
                closePasswordModal();
                showToast('üîí Note locked successfully!');
            }
        }

        // View history
        function viewHistory() {
            if (!currentNoteId) {
                showToast('‚ùå Please select a note first');
                return;
            }

            const note = notes.find(n => n.id === currentNoteId);
            if (!note || !note.history || note.history.length === 0) {
                showToast('üìú No history available for this note');
                return;
            }

            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = note.history.map((version, index) => `
                <div class="version-item" onclick="restoreVersion(${index})">
                    <div class="version-header">
                        <span>Version ${note.history.length - index}</span>
                        <span>${new Date(version.savedAt).toLocaleString()}</span>
                    </div>
                    <div class="version-preview">${version.content.substring(0, 100)}...</div>
                </div>
            `).reverse().join('');

            document.getElementById('historyModal').classList.add('active');
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        function restoreVersion(index) {
            if (!confirm('Restore this version? Current content will be saved to history.')) return;

            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                const version = note.history[index];
                document.getElementById('noteTitle').value = version.title;
                document.getElementById('noteContent').value = version.content;
                updateWordCount();
                closeHistoryModal();
                showToast('üìú Version restored! Don\'t forget to save.');
            }
        }

        // Toggle color picker
        function toggleColorPicker() {
            const picker = document.getElementById('colorOptions');
            picker.classList.toggle('active');
        }

        // Set note color
        function setNoteColor(color) {
            if (!currentNoteId) return;

            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.color = color;
                document.getElementById('currentColor').style.background = color;
                document.getElementById('noteContent').style.background = color;
                saveNotes();
                renderNotesList();
                toggleColorPicker();
                showToast('üé® Note color changed!');
            }
        }

        // Toggle pin
        function togglePin() {
            if (!currentNoteId) return;

            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.pinned = !note.pinned;
                const pin = document.getElementById('pinIcon');
                pin.textContent = note.pinned ? 'üìç' : 'üìå';
                saveNotes();
                renderNotesList();
                showToast(note.pinned ? 'üìç Note pinned to top!' : 'üìå Note unpinned');
            }
        }

        // Add image
        function addImage() {
            if (!currentNoteId) {
                showToast('‚ùå Please create a note first');
                return;
            }
            document.getElementById('imageInput').click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (limit to 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('‚ùå Image too large! Please use images under 5MB');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    // Store image data in note
                    if (!note.images) note.images = [];
                    note.images.push({
                        name: file.name,
                        data: e.target.result
                    });
                    
                    // Add image reference to content
                    const content = document.getElementById('noteContent');
                    const imagePlaceholder = `\n\n[üì∑ Image: ${file.name}]\n\n`;
                    content.value += imagePlaceholder;
                    
                    saveNotes();
                    updateWordCount();
                    showToast('üñºÔ∏è Image added! Save note to keep it.');
                }
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        // Show calendar
        function showCalendar() {
            const calendarContent = document.getElementById('calendarContent');
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            // Get notes grouped by date
            const notesByDate = {};
            notes.forEach(note => {
                const date = new Date(note.updatedAt).toDateString();
                if (!notesByDate[date]) notesByDate[date] = [];
                notesByDate[date].push(note);
            });

            // Build calendar
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let calendarHTML = `<div class="calendar-header">${now.toLocaleString('default', { month: 'long' })} ${year}</div>`;
            calendarHTML += '<div class="calendar-grid">';
            
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarHTML += `<div style="font-weight: 600; text-align: center; padding: 10px;">${day}</div>`;
            });

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div></div>';
            }

            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toDateString();
                const hasNotes = notesByDate[dateStr];
                const count = hasNotes ? hasNotes.length : 0;

                calendarHTML += `
                    <div class="calendar-day ${hasNotes ? 'has-notes' : ''}" onclick="showNotesForDate('${dateStr}')">
                        <div class="calendar-day-number">${day}</div>
                        ${count > 0 ? `<div class="calendar-day-count">${count} note${count > 1 ? 's' : ''}</div>` : ''}
                    </div>
                `;
            }

            calendarHTML += '</div>';
            calendarContent.innerHTML = calendarHTML;
            document.getElementById('calendarModal').classList.add('active');
        }

        function closeCalendarModal() {
            document.getElementById('calendarModal').classList.remove('active');
        }

        function showNotesForDate(dateStr) {
            const notesByDate = notes.filter(note => 
                new Date(note.updatedAt).toDateString() === dateStr
            );

            if (notesByDate.length === 0) {
                showToast('üìÖ No notes for this date');
                return;
            }

            if (notesByDate.length === 1) {
                closeCalendarModal();
                selectNote(notesByDate[0].id);
            } else {
                const titles = notesByDate.map((n, i) => `${i + 1}. ${n.title}`).join('\n');
                const choice = prompt(`Found ${notesByDate.length} notes:\n\n${titles}\n\nEnter number to open:`);
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < notesByDate.length) {
                    closeCalendarModal();
                    selectNote(notesByDate[index].id);
                }
            }
        }

        // Count words
        function countWords(text) {
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalNotes').textContent = notes.length;
            const favorites = notes.filter(n => n.favorite).length;
            document.getElementById('totalFavorites').textContent = favorites;
            const totalWords = notes.reduce((sum, note) => sum + countWords(note.content), 0);
            document.getElementById('totalWords').textContent = totalWords;
            
            if (notes.length > 0) {
                const latest = notes.reduce((a, b) => new Date(a.updatedAt) > new Date(b.updatedAt) ? a : b);
                document.getElementById('lastUpdated').textContent = new Date(latest.updatedAt).toLocaleDateString();
            }
        }

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Auto-save on content change
        let autoSaveTimeout;
        ['noteTitle', 'noteContent', 'noteTags'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                if (id === 'noteContent') {
                    updateWordCount();
                }
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    if (currentNoteId) {
                        saveCurrentNote();
                    }
                }, 2000); // Auto-save after 2 seconds of inactivity
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveCurrentNote();
            }
            // Ctrl/Cmd + N for new note
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                createNewNote();
            }
            // Ctrl/Cmd + P to print
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                printNote();
            }
            // Ctrl/Cmd + F to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            // Ctrl/Cmd + D to duplicate
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                duplicateNote();
            }
            // Ctrl/Cmd + K to toggle dark mode
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                toggleDarkMode();
            }
            // Ctrl/Cmd + Shift + V for voice input
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'V') {
                e.preventDefault();
                startVoiceInput();
            }
        });

        // Initialize app
        loadNotes();
        
        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        
        // Load language preference
        const savedLanguage = localStorage.getItem('saadnoteLanguage');
        if (savedLanguage) {
            currentLanguage = savedLanguage;
            document.getElementById('languageSelect').value = savedLanguage;
        }
        updateUILanguage();
    </script>
</body>
</html>
